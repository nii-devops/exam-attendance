{% extends "base.html" %}
{% from 'bootstrap5/form.html' import render_form %}

{% block title %}
    {{title}}
{% endblock title %}

{% block content %}


<div class="container d-flex justify-content-center align-items-center min-vh-100 my-5">
    <div style="max-width: 500px;" class="login-card col-lg-4 col-md-6 col-sm-10">
            <div class=" login-form">
                <div class="text-center mb-4">
                    <h3 class="heading fw-bold">{{heading}}</h3>
                    <hr class="my-4">
                </div>
                
               <div>
                    {{render_form(form)}}
               </div>
               <hr class="my-4">
                <div class="text-center mt-4">
                    <p class="mb-0">Staff not found? <a href="{{url_for('main.register_user')}}" class=" btn btn-sm btn-outline-primary fw-bold">Add Staff</a></p>
                </div>
                
            </div>

    </div>
</div>



{% endblock content %}


{% block scripts %}
<script>
$(document).ready(function() {
    // Function to update sessions based on selected date
    function updateSessions(date) {
        // Show loading indicator (if you have one)
        $('#session_field').prop('disabled', true);
        
        $.ajax({
            url: '/get_sessions',
            data: { date: date },
            type: 'GET',
            success: function(response) {
                var sessionSelect = $('#session_field');
                sessionSelect.empty();
                
                if (response.length > 0) {
                    $.each(response, function(index, session) {
                        sessionSelect.append(
                            $('<option></option>')
                                .val(session.id)
                                .text(session.name)
                        );
                    });
                } else {
                    sessionSelect.append(
                        $('<option></option>')
                            .val('')
                            .text('No sessions available for this date')
                    );
                }
                
                // Enable the select field again
                sessionSelect.prop('disabled', false);
            },
            error: function(error) {
                console.error('Error loading sessions:', error);
                $('#session_field').empty().append(
                    $('<option></option>')
                        .val('')
                        .text('Error loading sessions')
                );
                $('#session_field').prop('disabled', false);
            }
        });
    }

    // Date field change event handler
    $('#date_field').change(function() {
        var selectedDate = $(this).val();
        if (selectedDate) {
            // Update the URL for bookmarking/sharing (optional)
            var url = new URL(window.location.href);
            url.searchParams.set('date', selectedDate);
            history.pushState({}, '', url);
            
            // Update sessions dropdown
            updateSessions(selectedDate);
        }
    });

    // Initialize staff search autocomplete
    $('#staff_search_field').autocomplete({
        source: function(request, response) {
            $.ajax({
                url: '/search_staff',
                data: { q: request.term },
                type: 'GET',
                success: function(data) {
                    // Format data for autocomplete
                    var formattedData = $.map(data, function(item) {
                        return {
                            label: item.name,    // Display in dropdown
                            value: item.name,    // Value to show in input field
                            id: item.id          // ID to store in hidden field
                        };
                    });
                    response(formattedData);
                },
                error: function(error) {
                    console.error('Error searching staff:', error);
                    response([]);
                }
            });
        },
        minLength: 2,
        select: function(event, ui) {
            // Set the hidden field with the staff ID
            $('#staff_id_field').val(ui.item.id);
            
            // Add visual feedback
            $('#staff_search_field').removeClass('is-invalid').addClass('is-valid');
            return true;
        },
        change: function(event, ui) {
            // If nothing was selected but text exists
            if (!ui.item && $('#staff_search_field').val().trim() !== '') {
                $('#staff_id_field').val('');
                $('#staff_search_field').removeClass('is-valid').addClass('is-invalid');
                
                // Add validation feedback if not already present
                if (!$('#staff_feedback').length) {
                    $('#staff_search_field').after(
                        '<div id="staff_feedback" class="invalid-feedback">' +
                        'Please select a staff member from the dropdown.' +
                        '</div>'
                    );
                }
            } else if (!ui.item) {
                // Field was cleared
                $('#staff_id_field').val('');
                $('#staff_search_field').removeClass('is-valid is-invalid');
            }
        }
    });

    // Form submission validation
    $('form').on('submit', function(e) {
        // Validate that a staff member was selected if text was entered
        if ($('#staff_search_field').val().trim() !== '' && $('#staff_id_field').val() === '') {
            e.preventDefault();
            $('#staff_search_field').addClass('is-invalid');
            
            // Show validation message
            if (!$('#staff_feedback').length) {
                $('#staff_search_field').after(
                    '<div id="staff_feedback" class="invalid-feedback">' +
                    'Please select a valid staff member from the dropdown.' +
                    '</div>'
                );
            }
            return false;
        }
    });

    // Check for date parameter in URL and update sessions if present
    var urlParams = new URLSearchParams(window.location.search);
    var dateParam = urlParams.get('date');
    
    if (dateParam) {
        // Set the date field value
        $('#date_field').val(dateParam);
        
        // No need to manually update sessions here since the backend
        // already initializes the form with the correct sessions
        // when selected_date is provided
    }
});
</script>
{% endblock scripts %}
